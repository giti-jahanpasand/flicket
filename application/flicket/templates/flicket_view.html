{% extends "flicket_base.html" %}
<!-- extend from base layout -->
{% block content %}
    <div class="container">

        {% include 'flicket_apijson_users.html' %}

        <!-- flicket_view.html -->
        <div class="row flicket-row-title-main">
            <div class="col-sm-9">
                <div class="flicket-ticket-cell flicket-ticket-title-title" id="ticket-number-title">
                    #{{ ticket.id_zfill }} - {{ ticket.title }}
                </div>
            </div>
            <div class="col-sm-3 text-right" style="padding-top:10px;">
                {% if g.user.is_admin %}
                    <a class="btn btn-default flicket-btn-delete"
                       href="{{ url_for('flicket_bp.delete_ticket', ticket_id = ticket.id) }}">{{ _('delete') }}</a>
                {% endif %}
            </div>
        </div>
        <div class="row flicket-row-title-details">
            <div class="col-sm-2">
                <div class="flicket-ticket-cell flicket-ticket-cell-title">{{ _('Department') }}</div>
                <div class="flicket-ticket-cell">{{ ticket.category.department.department }}</div>
            </div>
            <div class="col-sm-3">
                <div class="flicket-ticket-cell flicket-ticket-cell-title">{{ _('Category') }}</div>
                <div class="flicket-ticket-cell">{{ ticket.category.category }}</div>
            </div>
            <div class="col-sm-2">
                <div class="flicket-ticket-cell flicket-ticket-cell-title">{{ _('Status') }}</div>
                <div class="flicket-ticket-cell">{{ ticket.current_status.status }}</div>
            </div>
            <div class="col-sm-2">
                <div class="flicket-ticket-cell flicket-ticket-cell-title">{{ _('Priority') }}</div>
                <div class="flicket-ticket-cell">{{ ticket.ticket_priority.priority }}</div>
            </div>
            <div class="col-sm-3">
                <div class="flicket-ticket-cell flicket-ticket-cell-title">{{ _('Assigned') }}</div>
                <div class="flicket-ticket-cell">
                    {% if ticket.assigned.username %}
                        {{ ticket.assigned.name }}
                    {% else %}ticket not assigned{% endif %}
                </div>
            </div>
        </div>

        <!-- subscribers -->
        <div class="row flicket-row-title-sub">
            <div class="col-sm-7">
                <div class="flicket-ticket-cell">
                    Subscribed: {% for s in ticket.subscribers %}
                    <a href="mailto:{{ s.user.email }}">{{ s.user.name }}</a>,
                    {% if loop.last %}
                    <a href="mailto:{{ s.user.email }}">{{ s.user.name }}</a>
                    {%  endif %}
                {% endfor %}
                </div>
            </div>
            <div class="col-sm-1">
                {% if ticket.is_subscribed(g.user) %}
                    <a class="btn btn-default btn-sm"
                       href="{{ url_for('flicket_bp.unsubscribe_ticket', ticket_id = ticket.id) }}">{{ _('unsubscribe') }}</a>
                {% else %}
                    <a class="btn btn-default btn-sm"
                       href="{{ url_for('flicket_bp.subscribe_ticket', ticket_id = ticket.id) }}">{{ _('subscribe') }}</a>
                {% endif %}
            </div>
            <div class="col-sm-4">
                <form action=""
                      class="form-horizontal"
                      enctype="multipart/form-data"
                      method="post"
                      name="subscribe_user">
                    {{ form.hidden_tag() }}
                    <div class="col-sm-8">
                        {{ subscribers_form.username(class="form-control", id="autocomplete-username", placeholder="User Name") }}
                    </div>
                    <div class="col-sm-4">
                        {{ subscribers_form.submit }}
                    </div>
                </form>
            </div>
        </div>

        <!-- pagination row -->
        <div class="row">
            <div class="col-sm-8">
                <ul class="pagination pagination-sm">{% for page in replies.iter_pages() %}
                    {% if page %}
                        {% if page != replies.page %}
                            <li>
                                <a href="{{ url_for('flicket_bp.ticket_view', ticket_id=ticket.id, page=page, **request.args) }}">
                                    {{ page }}</a>
                            </li>
                        {% else %}
                            <li class="active"><a
                                    href="{{ url_for('flicket_bp.ticket_view', ticket_id=ticket.id, page=page, **request.args) }}">
                                {{ page }}</a>
                            </li>
                        {% endif %}
                    {% else %}
                        <li><a href="">...</a></li>
                    {% endif %}
                {% endfor %}
                </ul>
            </div>
            <div class="col-sm-4 text-right">
                <ul class="list-inline flicket-ticket-details-btn-ul">
                    <li class="flicket-ticket-details-btn-li"><a style="text-decoration: none"
                                                                 href="{{ url_for('flicket_bp.ticket_claim', ticket_id = ticket.id) }}">{{ _('claim') }}</a>
                    </li>
                    <li class="flicket-ticket-details-btn-li"><a style="text-decoration: none"
                                                                 href="{{ url_for('flicket_bp.release', ticket_id = ticket.id) }}">{{ _('release') }}</a>
                    </li>
                    <li class="flicket-ticket-details-btn-li"><a style="text-decoration: none"
                                                                 href="{{ url_for('flicket_bp.ticket_assign', ticket_id = ticket.id) }}">{{ _('assign') }}</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- display ticket-->
        {{ display_post_box(ticket, page=page)|safe }}
        <!-- end display ticket -->
        <!-- display actions -->
        {% for action in ticket.actions %}
            <div class="row flicket-row flicket-row-action">
                {{ action.output_action()|safe }}
            </div>
        {% endfor %}
        <!-- end display actions -->

        <!-- flicket ticket replies -->
        {% for r in replies.items %}
            <!-- display replies -->
            {{ display_post_box(ticket=ticket, post=r, replies=replies, loop=loop, page=page)|safe }}

            <!-- display actions -->
            {% for action in r.actions %}
                <div class="row flicket-row flicket-row-action">
                    {{ action.output_action()|safe }}
                </div>
            {% endfor %}
            <!-- end display actions -->

        {% endfor %}

        {% include('flicket_form_reply.html') %}


    </div>

{% endblock %}